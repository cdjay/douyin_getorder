# 更新日志 (Changelog)

所有重要的项目更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)。

## [1.1.0] - 2026-01-03

### 新增 (Added)

#### Excel导入功能
- 📊 **售卖明细导入** - 支持售卖明细Excel文件自动导入到数据库
- 🎫 **旅行社预约明细导入** - 支持多sheet旅行社预约明细Excel文件导入
- 🔄 **自动监控** - 实时监控data文件夹，自动导入新文件（10秒扫描间隔）
- 🗑️ **自动清理** - 导入成功后自动删除Excel文件
- 📈 **进度显示** - 详细的导入进度和调试信息（总行数、表头、进度）
- ⚙️ **智能过滤** - 自动跳过"说明"类sheet和空行

#### 数据库表
- **orders_excel** - 售卖明细表，存储售卖明细Excel数据
- **travel_bookings** - 旅行社预约明细表，存储预约Excel数据

#### 任务监控
- ✅ **excel_import.py任务监控** - 为excel_import.py添加TaskManager支持
- 💓 **心跳更新** - 实时更新心跳时间到task_monitor表
- 📊 **状态记录** - 记录任务状态（RUNNING/STOPPED/ERROR）
- 🎮 **优雅退出** - Ctrl+C时正确更新状态为STOPPED

### 改进 (Improved)

#### Excel读取优化
- 🔄 使用`data_only=True`模式替代`read_only`，提高读取稳定性
- 📝 添加详细的调试日志（总行数、表头、读取进度）
- ✨ 每1000行打印一次进度，方便监控大文件导入
- 🚫 自动跳过"说明"类sheet（如"使用说明"）
- 🔍 空行检查，跳过无效数据行

#### 数据库优化
- ✅ 修复数据库表创建和迁移的执行顺序问题
  - 先创建表（`create_tables()`）
  - 后迁移字段（`migrate_all_models()`）
  - 解决"relation does not exist"错误
- 🔧 通用字段迁移，自动检测并添加缺失字段

### 修复 (Fixed)

- 🐛 修复Excel文件读取返回0行的问题
- 🐛 修复main.py和excel_import.py的执行顺序错误
- 🐛 修复excel_import.py缺少TaskManager初始化的问题
- 🐛 修复task_monitor只记录一条数据的问题

### 文档 (Documentation)

- 📖 更新README.md，添加Excel导入功能完整说明
- 📊 添加Excel文件格式说明和字段定义
- 📝 添加导入日志示例和数据库查询示例
- 🏗️ 更新项目结构文档

### 依赖 (Dependencies)

新增Python依赖：
- `openpyxl` - Excel文件读写库
- `python-dotenv` - 环境变量管理

### 测试 (Testing)

#### Excel导入测试结果
- ✅ 售卖明细导入：11667条记录
- ✅ 旅行社预约明细导入：9903条记录
  - 未预约-1: 113条
  - 已预约-1: 14条
  - 已完成-1: 9682条
  - 已拒单-1: 94条
- ✅ 总计导入：21570条记录
- ✅ 导入耗时：约10秒
- ✅ 空行跳过：正常
- ✅ Sheet过滤：正常

---

## [1.0.0] - 2026-01-01

### 新增 (Added)

#### API订单同步功能
- 🔁 **自动同步** - 定期拉取抖音生活订单数据
- 📱 **手机号解密** - 自动解密订单中的加密手机号
- 📄 **智能分页** - 按天切分，支持断点续传
- ⏰ **灵活配置** - 支持天数、日期、时间戳三种时间范围配置
- 💾 **数据安全** - Upsert机制避免重复，JSONB存储原始数据

#### 数据库表
- **orders** - API订单表，存储抖音API拉取的订单数据
- **task_monitor** - 任务监控表，记录程序运行状态

#### 任务监控
- 💓 **心跳监控** - 实时监控程序运行状态
- 🎮 **远程控制** - 支持通过数据库发送STOP/START指令
- 📊 **状态记录** - 记录任务状态、心跳时间、错误信息

#### Docker支持
- 🐳 **Docker镜像** - 完整的容器化部署方案
- 🔄 **优雅退出** - 支持SIGTERM和SIGINT信号处理
- 📝 **日志输出** - 标准输出便于Docker日志收集

### 技术栈
- Python 3.7+
- PostgreSQL
- SQLAlchemy
- Requests
- Cryptography

---

## 版本说明

### 版本命名规则
- 主版本号：重大功能更新或不兼容更改
- 次版本号：新增功能
- 修订号：Bug修复和小改进

### 分支说明
- `main` - 主分支，稳定版本
- `支持excel导入` - Excel功能开发分支（已合并到main）

---

## 贡献者

感谢所有为本项目做出贡献的开发者！

---

## 许可证

MIT License
